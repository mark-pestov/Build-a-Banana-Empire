name: Deploy to Roblox

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Aftman
        uses: ok-nick/setup-aftman@v0.4.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rojo
        run: aftman install

      - name: Build place file
        run: rojo build default.project.json --output BananaGame.rbxl

      - name: Deploy to Roblox
        env:
          ROBLOSECURITY: ${{ secrets.ROBLOSECURITY }}
          PLACE_ID: ${{ secrets.ROBLOX_PLACE_ID }}
        run: |
          # Install Node.js for deployment script
          sudo apt-get update
          sudo apt-get install -y nodejs npm

          # Create deployment script
          cat > deploy.js << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const ROBLOSECURITY = process.env.ROBLOSECURITY;
          const PLACE_ID = process.env.PLACE_ID;
          const FILE_PATH = 'BananaGame.rbxl';

          if (!ROBLOSECURITY || !PLACE_ID) {
            console.error('Missing required environment variables');
            process.exit(1);
          }

          console.log('Uploading to Roblox place:', PLACE_ID);

          // Read the file
          const fileContent = fs.readFileSync(FILE_PATH);

          // Function to get CSRF token by making a request that triggers the token header
          function getCsrfToken(callback) {
            const options = {
              hostname: 'data.roblox.com',
              port: 443,
              path: `/Data/Upload.ashx?assetid=${PLACE_ID}`,
              method: 'POST',
              headers: {
                'Cookie': `.ROBLOSECURITY=${ROBLOSECURITY}`,
                'User-Agent': 'Roblox/WinInet'
              }
            };

            const req = https.request(options, (res) => {
              // The X-CSRF-TOKEN comes in the response header, even on 403
              const csrfToken = res.headers['x-csrf-token'];
              if (csrfToken) {
                console.log('Got CSRF token from response');
                callback(null, csrfToken);
              } else {
                callback(new Error('Failed to get CSRF token from response headers'));
              }
            });

            req.on('error', callback);
            req.end();
          }

          // Get CSRF token first, then upload
          getCsrfToken((err, csrfToken) => {
            if (err) {
              console.error('Error getting CSRF token:', err);
              process.exit(1);
            }

            console.log('Got CSRF token, uploading...');

            // Upload to Roblox
            const options = {
              hostname: 'data.roblox.com',
              port: 443,
              path: `/Data/Upload.ashx?assetid=${PLACE_ID}`,
              method: 'POST',
              headers: {
                'Cookie': `.ROBLOSECURITY=${ROBLOSECURITY}`,
                'User-Agent': 'Roblox/WinInet',
                'Content-Type': 'application/xml',
                'Content-Length': fileContent.length,
                'X-CSRF-TOKEN': csrfToken
              }
            };

            const req = https.request(options, (res) => {
              let data = '';

              res.on('data', (chunk) => {
                data += chunk;
              });

              res.on('end', () => {
                if (res.statusCode === 200) {
                  console.log('Successfully deployed to Roblox!');
                  console.log('Response:', data);
                  process.exit(0);
                } else {
                  console.error('Failed to deploy. Status code:', res.statusCode);
                  console.error('Response:', data);
                  process.exit(1);
                }
              });
            });

            req.on('error', (error) => {
              console.error('Error deploying:', error);
              process.exit(1);
            });

            req.write(fileContent);
            req.end();
          });
          EOF

          # Run deployment
          node deploy.js
